#!/bin/bash
# romm-launcher — Steam shortcut launcher for RomM Sync plugin
# Called by Steam with LaunchOptions as argument: romm:{rom_id}

set -euo pipefail

# Parse rom ID from argument
if [[ -z "${1:-}" ]]; then
    echo "Usage: romm-launcher romm:<rom_id>" >&2
    exit 1
fi

ROM_ARG="$1"
if [[ ! "$ROM_ARG" =~ ^romm:([0-9]+)$ ]]; then
    echo "Invalid argument: $ROM_ARG (expected romm:<rom_id>)" >&2
    exit 1
fi

ROM_ID="${BASH_REMATCH[1]}"

# Find plugin runtime directory
PLUGIN_DIR=""
for candidate in \
    "${DECKY_PLUGIN_RUNTIME_DIR:-}" \
    "$HOME/.local/share/decky/plugins/decky-romm-sync" \
    "$HOME/homebrew/plugins/decky-romm-sync"; do
    if [[ -d "$candidate" ]]; then
        PLUGIN_DIR="$candidate"
        break
    fi
done

# Data dir for state.json (Decky stores runtime data in data/, not settings/)
DATA_DIR=""
for candidate in \
    "${DECKY_PLUGIN_RUNTIME_DIR:-}" \
    "$HOME/homebrew/data/decky-romm-sync" \
    "$HOME/.local/share/decky/data/decky-romm-sync"; do
    if [[ -d "$candidate" ]]; then
        DATA_DIR="$candidate"
        break
    fi
done

if [[ -z "$DATA_DIR" ]]; then
    DATA_DIR="$HOME/homebrew/data/decky-romm-sync"
    mkdir -p "$DATA_DIR"
fi

STATE_FILE="$DATA_DIR/state.json"

# Check if ROM is installed by reading state.json
if [[ -f "$STATE_FILE" ]]; then
    # Use python3 to parse JSON (always available)
    ROM_INFO=$(python3 -c "
import json, sys
with open('$STATE_FILE') as f:
    state = json.load(f)
installed = state.get('installed_roms', {})
rom = installed.get('$ROM_ID')
if rom:
    print(rom.get('system', ''))
    print(rom.get('file_path', ''))
else:
    sys.exit(1)
" 2>/dev/null) || ROM_INFO=""
fi

if [[ -n "${ROM_INFO:-}" ]]; then
    SYSTEM=$(echo "$ROM_INFO" | head -1)
    ROM_PATH=$(echo "$ROM_INFO" | tail -1)

    if [[ -f "$ROM_PATH" ]]; then
        # Launch with RetroDECK (auto-detects system from roms/{system}/ path)
        exec flatpak run net.retrodeck.retrodeck "$ROM_PATH"
    else
        echo "ROM file missing: $ROM_PATH — queueing download" >&2
    fi
    # Fall through to download request if ROM file is missing
fi

# ROM not installed — request download
REQUESTS_FILE="$DATA_DIR/download_requests.json"

python3 -c "
import json, os, fcntl
path = '$REQUESTS_FILE'
try:
    with open(path, 'r') as f:
        requests = json.load(f)
except (FileNotFoundError, json.JSONDecodeError):
    requests = []
requests.append({'rom_id': $ROM_ID, 'timestamp': $(date +%s)})
with open(path, 'w') as f:
    fcntl.flock(f, fcntl.LOCK_EX)
    json.dump(requests, f)
    fcntl.flock(f, fcntl.LOCK_UN)
"

# Try to show a notification
if command -v notify-send &>/dev/null; then
    notify-send "RomM Sync" "Download queued for ROM #$ROM_ID. Play again when complete."
fi

exit 0
